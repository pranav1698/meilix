# This provides us with GCC binary support so we can run bash
language: generic

# Try to supply the packages from Travis so that when we run build.sh we won't
# be required to download them again.
include:
  - os: linux
    addons:
      apt:
        update: true
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - debootstrap
          - genisoimage
          - p7zip-full
          - squashfs-tools
          - ubuntu-dev-tools
          - dpkg-dev
          - debhelper
          - fakeroot
          - devscripts
          - jq

sudo: required
dist: xenial
git:
  depth: 22

script:
  - export LC_ALL="en_US.UTF-8"
  - export LANG="en_US.UTF-8"
  - export LANGUAGE="en_US.UTF-8"
  - sudo locale-gen en_US.UTF-8
  - sudo dpkg-reconfigure locales
  - chmod +x ./build.sh
  - ./build.sh |& tee log.txt

before_deploy:
  - export image_name="`echo *.iso`"
  - cat *.iso > "/home/travis/${image_name}"
  - cp log.txt /home/travis/log.txt

notifications:
  slack: fossasia:3pMkQrSogvEMfnu9aJDW2ZYC

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: hfbyUlk1Rg/Ye32wPxo1s+FXb21gmRi6dneInwxS0zihHHe+3VZP/aTkddNO1T1PVn+p7i7BnWKv8HRNHyWqPVoIX6ta3jp3J+jRlLL1efl+9KO0f8FfyswEqf76eQz/QUzh9WJ25BV9UUltqYzgug9Rgfbk5b94IXnPF7R/UmfuAadvT6I9xpQRSjDCCHqmGVi1xV69/iAnXogdrJtda9m18I+bj5sFHVXBwuRlIZkjoxxr3lqESRYud9sb01RdLvvBY3DFa7SjBshjWHtI+orbl0YALrkryFl3BXAzI1/bCwQ5bl4pd1hFKD2s2JNlBwwQ2eecD5Pvjes9gkGdLMkIaFM3UgvyQtRIhj3uExFexryAUwxdGBCkb8elHFqynvGNB0OLSPK91caDsX5t5ZzxOZ35wIlTqpVwSem5em+DVlB8fKcfiSc/b+8gj3FwXKejsp6gWy1EKvMKajNXugZEHcPpy76t91lG/YyIqR2EFzJRhV9JmEXyEUtvwRoV5thMtzLaVAOxPImwUCptFiTkwq7xF1K3vJGft1xdYn8i3qO9LrVNUcOGeS7T1v+kXS2IzWp23RQO9eYgifzQ+J9qvjY3J8Tr2MdaxPd72Tinsz/JzxTj15S0D4MuZPsk/ImpGd4+mlCQjIAScnfNs5eNdTT80UwOW/UQNxKo2sQ=
  file_glob: true # http://stackoverflow.com/a/28579635/1320237
  file: 
    - "/home/travis/${image_name}"
    - "/home/travis/log.txt"
  on:
    all_branches: true

after_deploy:
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then bash ./scripts/releases_maintainer.sh; fi'
  - cd scripts/mail-scripts && ./mail.py